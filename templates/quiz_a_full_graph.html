<!DOCTYPE html>
<html>
<head>
    <title>出題範囲全アイテム関係性グラフ - League of Legends Item Quiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .full-graph-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .graph-controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .graph-controls button {
            background: #0596aa;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .graph-controls button:hover {
            background: #047a8a;
        }
        .graph-controls button.active {
            background: #ffc107;
            color: #333;
        }
        .cytoscape-full-graph {
            width: 100%;
            height: 800px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
        }
        .d3-full-graph {
            width: 100%;
            height: 800px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        .graph-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #0596aa;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 2px solid;
        }
        .back-link {
            display: inline-block;
            background: #0596aa;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 20px;
        }
        .back-link:hover {
            background: #047a8a;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        .filter-controls {
            margin: 15px 0;
            text-align: center;
        }
        .filter-controls label {
            margin: 0 10px;
            font-weight: bold;
        }
        .filter-controls input[type="range"] {
            width: 200px;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="full-graph-container">
        <h1>出題範囲全アイテム関係性グラフ</h1>
        
        <div class="graph-stats">
            <div class="stat-item">
                <div class="stat-number" id="total-items">193</div>
                <div class="stat-label">総アイテム数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="total-edges">393</div>
                <div class="stat-label">関係性数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="basic-items">18</div>
                <div class="stat-label">素材アイテム</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="intermediate-items">44</div>
                <div class="stat-label">中間アイテム</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="legendary-items">124</div>
                <div class="stat-label">レジェンダリー</div>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #d4edda; border-color: #28a745;"></div>
                <span>素材アイテム（子がいない）</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #cce7ff; border-color: #007bff;"></div>
                <span>中間アイテム（親も子もいる）</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff3cd; border-color: #ffc107;"></div>
                <span>レジェンダリーアイテム（親がいない）</span>
            </div>
        </div>
        
        <div class="graph-controls">
            <button id="cytoscape-btn" class="active" onclick="showCytoscapeGraph()">Cytoscape表示</button>
            <button id="d3-btn" onclick="showD3Graph()">D3.js表示</button>
            <button onclick="resetLayout()">レイアウト リセット</button>
            <button onclick="fitToScreen()">画面に合わせる</button>
        </div>
        
        <div class="filter-controls">
            <label for="min-price">最低価格:</label>
            <input type="range" id="min-price" min="0" max="5000" value="0" step="100">
            <span id="min-price-value">0G</span>
            
            <label for="max-price">最高価格:</label>
            <input type="range" id="max-price" min="0" max="5000" value="5000" step="100">
            <span id="max-price-value">5000G</span>
            
            <button onclick="applyPriceFilter()">フィルター適用</button>
            <button onclick="clearFilter()">フィルター解除</button>
        </div>
        
        <div class="loading" id="loading">グラフデータを読み込み中...</div>
        
        <div id="cytoscape-full-graph" class="cytoscape-full-graph" style="display: none;"></div>
        <div id="d3-full-graph" class="d3-full-graph" style="display: none;"></div>
        
        <div style="margin-top: 30px;">
            <h3>使い方</h3>
            <ul>
                <li><strong>Cytoscape表示</strong>: 階層的なレイアウトで関係性を表示</li>
                <li><strong>D3.js表示</strong>: 物理シミュレーションによる動的レイアウト</li>
                <li><strong>価格フィルター</strong>: 指定した価格帯のアイテムのみ表示</li>
                <li><strong>ズーム・パン</strong>: マウスホイールでズーム、ドラッグで移動</li>
                <li><strong>ノードドラッグ</strong>: D3.jsでノードをドラッグして位置調整可能</li>
            </ul>
            
            <h3>グラフの読み方</h3>
            <ul>
                <li><strong>ノード</strong>: 各アイテムを表示（画像付き）</li>
                <li><strong>エッジ</strong>: 素材関係（矢印は合成方向）</li>
                <li><strong>色分け</strong>: 関係性に基づく分類（素材・中間・レジェンダリー）</li>
                <li><strong>サイズ</strong>: アイテムの重要度（多く使われる素材ほど大きく表示）</li>
            </ul>
        </div>
        
        <a href="/" class="back-link">メインページに戻る</a>
        <a href="/quiz_a_algorithm" class="back-link">アルゴリズム解説に戻る</a>
    </div>

    <script>
        let fullGraphData = null;
        let cy = null;
        let currentGraph = 'cytoscape';
        
        // 価格フィルターの値更新
        document.getElementById('min-price').addEventListener('input', function() {
            document.getElementById('min-price-value').textContent = this.value + 'G';
        });
        
        document.getElementById('max-price').addEventListener('input', function() {
            document.getElementById('max-price-value').textContent = this.value + 'G';
        });
        
        // グラフデータを読み込み
        async function loadGraphData() {
            try {
                const response = await fetch('/static/full_graph_data.json');
                fullGraphData = await response.json();
                
                // 統計情報を更新
                document.getElementById('total-items').textContent = fullGraphData.stats.total_items;
                document.getElementById('total-edges').textContent = fullGraphData.stats.edges;
                document.getElementById('basic-items').textContent = fullGraphData.stats.basic_items;
                document.getElementById('intermediate-items').textContent = fullGraphData.stats.intermediate_items;
                document.getElementById('legendary-items').textContent = fullGraphData.stats.legendary_items;
                
                document.getElementById('loading').style.display = 'none';
                showCytoscapeGraph();
                
            } catch (error) {
                console.error('グラフデータの読み込みに失敗:', error);
                document.getElementById('loading').textContent = 'データの読み込みに失敗しました。';
            }
        }
        
        function showCytoscapeGraph() {
            currentGraph = 'cytoscape';
            document.getElementById('cytoscape-btn').classList.add('active');
            document.getElementById('d3-btn').classList.remove('active');
            document.getElementById('cytoscape-full-graph').style.display = 'block';
            document.getElementById('d3-full-graph').style.display = 'none';
            
            if (!fullGraphData) return;
            
            initializeCytoscapeGraph(fullGraphData);
        }
        
        function showD3Graph() {
            currentGraph = 'd3';
            document.getElementById('cytoscape-btn').classList.remove('active');
            document.getElementById('d3-btn').classList.add('active');
            document.getElementById('cytoscape-full-graph').style.display = 'none';
            document.getElementById('d3-full-graph').style.display = 'block';
            
            if (!fullGraphData) return;
            
            initializeD3Graph(fullGraphData);
        }
        
        function initializeCytoscapeGraph(data) {
            // Cytoscapeエレメントに変換
            const elements = [];
            
            // ノード追加
            data.nodes.forEach(node => {
                elements.push({
                    data: {
                        id: node.id,
                        label: node.label,
                        category: node.category,
                        price: node.price,
                        itemId: node.itemId
                    }
                });
            });
            
            // エッジ追加
            data.edges.forEach(edge => {
                elements.push({
                    data: {
                        source: edge.source,
                        target: edge.target,
                        type: edge.type
                    }
                });
            });
            
            cy = cytoscape({
                container: document.getElementById('cytoscape-full-graph'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'bottom',
                            'text-halign': 'center',
                            'text-wrap': 'wrap',
                            'text-max-width': '80px',
                            'font-size': '8px',
                            'color': '#333',
                            'width': 40,
                            'height': 40,
                            'border-width': 2,
                            'text-background-color': 'rgba(255, 255, 255, 0.8)',
                            'text-background-opacity': 1,
                            'text-background-padding': '2px'
                        }
                    },
                    // 素材アイテム（子がいない）
                    {
                        selector: 'node[category="basic"]',
                        style: {
                            'background-image': function(ele) {
                                return 'url(https://ddragon.leagueoflegends.com/cdn/{{ patch_version }}/img/item/' + ele.data('itemId') + '.png)';
                            },
                            'background-fit': 'cover',
                            'background-opacity': 0.9,
                            'border-color': '#28a745',
                            'border-width': 3,
                            'width': 40,
                            'height': 40
                        }
                    },
                    // 中間アイテム（親も子もいる）
                    {
                        selector: 'node[category="intermediate"]',
                        style: {
                            'background-image': function(ele) {
                                return 'url(https://ddragon.leagueoflegends.com/cdn/{{ patch_version }}/img/item/' + ele.data('itemId') + '.png)';
                            },
                            'background-fit': 'cover',
                            'background-opacity': 0.9,
                            'border-color': '#007bff',
                            'border-width': 3,
                            'width': 50,
                            'height': 50
                        }
                    },
                    // レジェンダリーアイテム（親がいない）
                    {
                        selector: 'node[category="legendary"]',
                        style: {
                            'background-image': function(ele) {
                                return 'url(https://ddragon.leagueoflegends.com/cdn/{{ patch_version }}/img/item/' + ele.data('itemId') + '.png)';
                            },
                            'background-fit': 'cover',
                            'background-opacity': 0.9,
                            'border-color': '#ffc107',
                            'border-width': 4,
                            'width': 60,
                            'height': 60,
                            'font-weight': 'bold'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 1,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    }
                ],
                layout: {
                    name: 'breadthfirst',
                    directed: true,
                    padding: 30,
                    spacingFactor: 1.5,
                    animate: true,
                    animationDuration: 1000
                }
            });
        }
        
        function initializeD3Graph(data) {
            // D3.jsの実装はより複雑になるため、シンプル版を実装
            const container = document.getElementById('d3-full-graph');
            container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">D3.js版は大規模データのため実装調整中...<br>Cytoscape版をご利用ください。</div>';
        }
        
        function applyPriceFilter() {
            const minPrice = parseInt(document.getElementById('min-price').value);
            const maxPrice = parseInt(document.getElementById('max-price').value);
            
            if (!cy) return;
            
            cy.nodes().forEach(node => {
                const price = node.data('price');
                if (price >= minPrice && price <= maxPrice) {
                    node.style('display', 'element');
                } else {
                    node.style('display', 'none');
                }
            });
        }
        
        function clearFilter() {
            if (!cy) return;
            
            cy.nodes().style('display', 'element');
            document.getElementById('min-price').value = 0;
            document.getElementById('max-price').value = 5000;
            document.getElementById('min-price-value').textContent = '0G';
            document.getElementById('max-price-value').textContent = '5000G';
        }
        
        function resetLayout() {
            if (!cy) return;
            
            cy.layout({
                name: 'breadthfirst',
                directed: true,
                padding: 30,
                spacingFactor: 1.5,
                animate: true,
                animationDuration: 1000
            }).run();
        }
        
        function fitToScreen() {
            if (!cy) return;
            cy.fit(null, 50);
        }
        
        // ページ読み込み時にデータを読み込み
        document.addEventListener('DOMContentLoaded', loadGraphData);
    </script>
</body>
</html>