<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出題アルゴリズム解説 - League of Legends Item Quiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .algorithm-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .algorithm-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .algorithm-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .algorithm-header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        .step-container {
            margin: 30px 0;
        }
        .step-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }
        .step-number {
            position: absolute;
            top: -15px;
            left: 20px;
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .step-title {
            color: #2c3e50;
            margin-bottom: 10px;
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        .step-description {
            color: #6c757d;
            line-height: 1.6;
        }
        .example-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
        }
        .example-title {
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .item-tag {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .correct-answer {
            background: #28a745;
        }
        .algorithm-flow {
            background: #f1f3f4;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .flow-arrow {
            text-align: center;
            color: #007bff;
            font-size: 24px;
            margin: 10px 0;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .feature-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .feature-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .feature-title {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .feature-description {
            color: #6c757d;
            line-height: 1.5;
        }
        .back-links {
            text-align: center;
            margin-top: 30px;
        }
        .back-link {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin: 0 10px;
            transition: background 0.3s;
        }
        .back-link:hover {
            background: #0056b3;
        }
        .back-link.secondary {
            background: #6c757d;
        }
        .back-link.secondary:hover {
            background: #5a6268;
        }
        .graph-container {
            width: 100%;
            min-height: 400px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        .graph-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border-radius: 50%;
            border: 2px solid #333;
        }
        .node-text {
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            fill: white;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="algorithm-container">
        <div class="algorithm-header">
            <h1>🎯 出題アルゴリズム解説</h1>
            <p>League of Legends Item Quiz の出題システムがどのように動作するかを詳しく解説します</p>
        </div>

        <div class="step-container">
            <div class="step-card">
                <div class="step-number">1</div>
                <div class="step-title">アイテムデータの取得</div>
                <div class="step-description">
                    Riot Games公式API（Data Dragon）からパッチ{{ patch_version }}のアイテムデータを取得します。
                    このデータには全アイテムの情報（名前、価格、画像、素材など）が含まれています。
                </div>
                <div class="example-box">
                    <div class="example-title">データ取得URL</div>
                    <code>https://ddragon.leagueoflegends.com/cdn/{{ patch_version }}/data/ja_JP/item.json</code>
                </div>
            </div>

            <div class="step-card">
                <div class="step-number">2</div>
                <div class="step-title">出題対象アイテムの選定</div>
                <div class="step-description">
                    全アイテムの中から出題に適したアイテムを選定します。除外されるアイテムは以下の通りです：
                    <ul>
                        <li>オーンの特殊アイテム（requiredAlly == 'Ornn'）</li>
                        <li>消費アイテム（ポーション類）</li>
                        <li>ワード・トリンケット類</li>
                        <li>ブーツ類（移動速度アイテム）</li>
                    </ul>
                </div>
            </div>

            <div class="step-card">
                <div class="step-number">3</div>
                <div class="step-title">出題アイテムのランダム選択</div>
                <div class="step-description">
                    選定されたアイテムの中から、ランダムに1つのアイテムを選択します。
                    このアイテムが問題の正解となります。
                </div>
                <div class="example-box">
                    <div class="example-title">選択例</div>
                    <div class="item-list">
                        <span class="item-tag correct-answer">インフィニティエッジ</span>
                        <span class="item-tag">（正解アイテム）</span>
                    </div>
                </div>
            </div>

            <div class="step-card">
                <div class="step-number">4</div>
                <div class="step-title">アイテムツリーの構築</div>
                <div class="step-description">
                    選択されたアイテムから、そのアイテムを作成するために必要な全ての素材アイテムを探索し、
                    アイテムツリーを構築します。これには直接の素材だけでなく、
                    素材の素材（間接的な素材）も全て含まれます。
                </div>
                <div class="example-box">
                    <div class="example-title">マリグナンスの場合</div>
                    <div class="item-list">
                        <span class="item-tag">悪魔の杖</span>
                        <span class="item-tag">ブラスティングワンド</span>
                        <span class="item-tag">アンプティングトーム</span>
                        <span class="item-tag">アンプティングトーム</span>
                    </div>
                </div>
                <div class="graph-container" id="material-tree-graph">
                    <div class="graph-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #9c27b0;"></div>
                            <span>出題アイテム</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4caf50;"></div>
                            <span>直接素材</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2196f3;"></div>
                            <span>間接素材</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step-card">
                <div class="step-number">5</div>
                <div class="step-title">拡張ファミリーの取得</div>
                <div class="step-description">
                    選択されたアイテムの「拡張ファミリー」を取得します。これは、そのアイテムと何らかの関係性を持つアイテムの集合です。
                    具体的には以下の関係を持つアイテムが含まれます：
                    <ul>
                        <li><strong>直接的な親子関係</strong>: 素材アイテムと完成品アイテム</li>
                        <li><strong>兄弟関係</strong>: 同じ素材から作られるアイテム</li>
                        <li><strong>親戚関係</strong>: 共通の素材を持つアイテム</li>
                        <li><strong>2次的な関係</strong>: 関連アイテムの関連アイテム</li>
                    </ul>
                </div>
                <div class="example-box">
                    <div class="example-title">マリグナンスの拡張ファミリー例</div>
                    <div style="margin: 10px 0;">
                        <strong>📍 正解の素材アイテム</strong><br>
                        <div class="item-list">
                            <span class="item-tag correct-answer">悪魔の杖</span>
                            <span class="item-tag correct-answer">ブラスティングワンド</span>
                            <span class="item-tag correct-answer">アンプティングトーム</span>
                            <span class="item-tag correct-answer">アンプティングトーム</span>
                        </div>
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>📍 拡張ファミリー（ひっかけ候補）</strong><br>
                        <div class="item-list">
                            <span class="item-tag">暗黒の印</span>
                            <span class="item-tag">（アンプティングトーム使用）</span>
                            <span class="item-tag">ナッシャーの歯</span>
                            <span class="item-tag">（悪魔の杖使用）</span>
                            <span class="item-tag">ヘクステックオルタネーター</span>
                            <span class="item-tag">（アンプティングトーム使用）</span>
                        </div>
                    </div>
                </div>
                <div class="graph-container" id="extended-family-graph">
                    <div class="graph-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #9c27b0;"></div>
                            <span>出題アイテム</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4caf50;"></div>
                            <span>正解素材</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff5722;"></div>
                            <span>ひっかけ候補</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step-card">
                <div class="step-number">6</div>
                <div class="step-title">選択肢の生成</div>
                <div class="step-description">
                    拡張ファミリーから正解の素材アイテムを除外し、残ったアイテムの中から最大10個をランダムに選択します。
                    これにより、以下のような効果的なひっかけ選択肢が生成されます：
                    <ul>
                        <li><strong>関連性のあるひっかけ</strong>: 完全に無関係ではなく、何らかの関係性を持つアイテム</li>
                        <li><strong>学習効果</strong>: アイテム間の関係性を深く理解する必要がある</li>
                        <li><strong>適切な難易度</strong>: 知識があれば解けるが、曖昧な理解では間違える</li>
                    </ul>
                </div>
                <div class="example-box">
                    <div class="example-title">なぜこの方法が効果的なのか</div>
                    <div style="margin: 10px 0;">
                        <strong>❌ 悪い例</strong>: 完全に無関係なアイテム（例：ポーション類）<br>
                        <strong>✅ 良い例</strong>: 関連性があるが正解ではないアイテム（例：同じ素材を使う別のアイテム）
                    </div>
                    <div style="margin: 10px 0;">
                        これにより、プレイヤーは「なんとなく関係がありそう」なアイテムに惑わされず、
                        正確な素材関係を理解する必要があります。
                    </div>
                </div>
            </div>

            <div class="step-card">
                <div class="step-number">7</div>
                <div class="step-title">正解判定</div>
                <div class="step-description">
                    ユーザーが選択したアイテムが、構築されたアイテムツリーに含まれる素材アイテムと
                    完全に一致するかどうかを判定します。部分的な正解は認められません。
                </div>
            </div>
        </div>

        <div class="algorithm-flow">
            <h3 style="text-align: center; margin-bottom: 20px;">🔄 アルゴリズムの流れ</h3>
            <div style="text-align: center;">
                <div>アイテムデータ取得</div>
                <div class="flow-arrow">↓</div>
                <div>出題対象フィルタリング</div>
                <div class="flow-arrow">↓</div>
                <div>ランダム選択</div>
                <div class="flow-arrow">↓</div>
                <div>アイテムツリー構築</div>
                <div class="flow-arrow">↓</div>
                <div>拡張ファミリー取得</div>
                <div class="flow-arrow">↓</div>
                <div>選択肢生成</div>
                <div class="flow-arrow">↓</div>
                <div>正解判定</div>
            </div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-icon">🎲</div>
                <div class="feature-title">ランダム性</div>
                <div class="feature-description">
                    毎回異なるアイテムが出題されるため、
                    繰り返し学習が可能です。
                </div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">🔍</div>
                <div class="feature-title">完全性</div>
                <div class="feature-description">
                    直接・間接を問わず、すべての素材アイテムが
                    正解に含まれます。
                </div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">📊</div>
                <div class="feature-title">公平性</div>
                <div class="feature-description">
                    公式APIデータを使用し、
                    常に最新パッチの情報で出題されます。
                </div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">⚡</div>
                <div class="feature-title">効率性</div>
                <div class="feature-description">
                    高速なアルゴリズムにより、
                    即座に問題が生成されます。
                </div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">🎯</div>
                <div class="feature-title">教育的効果</div>
                <div class="feature-description">
                    巧妙なひっかけ選択肢により、
                    深い理解と正確な知識が身につきます。
                </div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">⚖️</div>
                <div class="feature-title">難易度バランス</div>
                <div class="feature-description">
                    適切な難易度調整により、
                    挑戦的だが公平な問題を提供します。
                </div>
            </div>
        </div>

        <div class="back-links">
            <a href="/" class="back-link">メインページに戻る</a>
            <a href="/quiz_a_full_graph" class="back-link secondary">関係性グラフを見る</a>
        </div>
    </div>

    <script>
        // マリグナンスの素材ツリーグラフ
        function drawMaterialTreeGraph() {
            const container = d3.select("#material-tree-graph");
            const width = container.node().getBoundingClientRect().width;
            const height = 400;

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            // データ定義（マリグナンスの素材ツリー）
            const nodes = [
                { id: "malignance", name: "マリグナンス", level: 0, color: "#9c27b0" },
                { id: "lost_chapter", name: "悪魔の杖", level: 1, color: "#4caf50" },
                { id: "blasting_wand", name: "ブラスティングワンド", level: 1, color: "#4caf50" },
                { id: "amp_tome1", name: "アンプティングトーム", level: 2, color: "#2196f3" },
                { id: "amp_tome2", name: "アンプティングトーム", level: 2, color: "#2196f3" }
            ];

            const links = [
                { source: "malignance", target: "lost_chapter" },
                { source: "malignance", target: "blasting_wand" },
                { source: "lost_chapter", target: "amp_tome1" },
                { source: "lost_chapter", target: "amp_tome2" }
            ];

            // シミュレーション設定
            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            // リンクの描画
            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("stroke", "#999")
                .attr("stroke-width", 2);

            // ノードの描画
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .enter().append("g");

            node.append("circle")
                .attr("r", 30)
                .attr("fill", d => d.color)
                .attr("stroke", "#333")
                .attr("stroke-width", 3);

            node.append("text")
                .attr("class", "node-text")
                .text(d => d.name)
                .style("font-size", d => d.name.length > 6 ? "10px" : "12px");

            // シミュレーションの更新
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });
        }

        // 拡張ファミリーグラフ
        function drawExtendedFamilyGraph() {
            const container = d3.select("#extended-family-graph");
            const width = container.node().getBoundingClientRect().width;
            const height = 400;

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            // データ定義（マリグナンスの拡張ファミリー）
            const nodes = [
                { id: "malignance", name: "マリグナンス", type: "target", color: "#9c27b0" },
                // 正解素材
                { id: "lost_chapter", name: "悪魔の杖", type: "correct", color: "#4caf50" },
                { id: "blasting_wand", name: "ブラスティングワンド", type: "correct", color: "#4caf50" },
                { id: "amp_tome1", name: "アンプティングトーム", type: "correct", color: "#4caf50" },
                // ひっかけ候補
                { id: "dark_seal", name: "暗黒の印", type: "decoy", color: "#ff5722" },
                { id: "nashors_tooth", name: "ナッシャーの歯", type: "decoy", color: "#ff5722" },
                { id: "hextech_alternator", name: "ヘクステックオルタネーター", type: "decoy", color: "#ff5722" },
                { id: "mejais", name: "メジャイのソウルスティーラー", type: "decoy", color: "#ff5722" }
            ];

            const links = [
                // 正解の関係
                { source: "malignance", target: "lost_chapter", type: "material" },
                { source: "malignance", target: "blasting_wand", type: "material" },
                { source: "lost_chapter", target: "amp_tome1", type: "material" },
                // ひっかけの関係
                { source: "dark_seal", target: "amp_tome1", type: "family" },
                { source: "nashors_tooth", target: "lost_chapter", type: "family" },
                { source: "hextech_alternator", target: "amp_tome1", type: "family" },
                { source: "mejais", target: "dark_seal", type: "family" }
            ];

            // シミュレーション設定
            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(120))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(width / 2, height / 2));

            // リンクの描画
            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("stroke", d => d.type === "material" ? "#4caf50" : "#ff5722")
                .attr("stroke-width", d => d.type === "material" ? 3 : 1)
                .attr("stroke-dasharray", d => d.type === "family" ? "5,5" : "none")
                .attr("opacity", d => d.type === "material" ? 1 : 0.5);

            // ノードの描画
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .enter().append("g");

            node.append("circle")
                .attr("r", d => d.type === "target" ? 35 : 25)
                .attr("fill", d => d.color)
                .attr("stroke", "#333")
                .attr("stroke-width", 3);

            node.append("text")
                .attr("class", "node-text")
                .text(d => d.name)
                .style("font-size", d => d.name.length > 8 ? "10px" : "12px");

            // シミュレーションの更新
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });
        }

        // ページ読み込み時にグラフを描画
        window.addEventListener("DOMContentLoaded", () => {
            drawMaterialTreeGraph();
            drawExtendedFamilyGraph();
        });
    </script>
</body>
</html>